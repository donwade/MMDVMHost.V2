#!/bin/bash
reset
make clean &>/dev/null
NAME=`uname -m`
unset CFLAGS

TGT_ARCH=arm-linux-gnueabihf
if [ "$1" == "--Debug" ]; then
    CFLAGS='-O0 -ggdb '
fi

if [ "$NAME" == "x86_64" ]; then

    SYSROOT=/home/dwade/remote.root

    [[ -d ${SYSROOT} ]] || mkdir -p ${SYSROOT} 
    
    if [ ! -d ${SYSROOT}/lib ]; then
        echo "need to mount pi root"
        sudo mount whitebox:/ ${SYSROOT}
    fi

    export PATH=/home/dwade/x-tools/arm-linux-gnueabihf/bin:$PATH

    export CXX=`which arm-linux-gnueabihf-g++` 
    export LD=`which arm-linux-gnueeabihf-c++`

    export CFLAGS=" $CFLAGS --sysroot=${SYSROOT} "
    
    export CXXFLAGS=$CFLAGS
    
    LDFLAGS="-L${SYSROOT}/usr/lib/gcc/arm-linux-gnueabihf/10 -L${SYSROOT}/usr/lib  -L${SYSROOT}/usr/lib/$TGT_ARCH -Wl,--sysroot=${SYSROOT} --sysroot=${SYSROOT} "
    #LDFLAGS+="-Wl,--verbose "
    export LDFLAGS 

    make VERBOSE=1  all | tee make.log
    ret=${PIPESTATUS[0]}
    if [ $ret != 0 ]; then
        RED "\nmake failed \n"
        exit
    fi
    xcp-whitebox .
    rm *.o
    GREEN "\n make passed local drive cleaned up\n"
else
    make CFLAGS="$CFLAGS" CXXFLAGS="$CFLAGS" SHELL='/bin/bash -x' -j3
    if [ $? == 0 ]; then
        runit --stop
        runit --disable
        sudo make uninstall-service
        echo
        sudo make install
        sudo make install-service
        echo
        ls -al MMDVMHost
        echo
        ls -al `which MMDVMHost`
        echo
        runit --enable
        runit --start
        rm *.o
        ./runit
    fi
fi
YELLOW "see also make install-service"
YELLOW "         make uninstall-service"
echo
ps -ef | grep -v grep | grep mmdvm*

